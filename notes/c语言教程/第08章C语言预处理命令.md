#编程基础  #c语言中文网 #c语言教程  

- 在编译和链接之前，还需要对源文件进行一些**文本方面的操作**，比如文本替换、文件包含、删除部分代码等，这个过程叫做预处理，由预处理程序完成。

# 8.1 C语言预处理命令是什么？

- 这种以`#`号开头的命令称为预处理命令

**C语言源文件要经过编译、链接才能生成可执行程序：**

1. 编译（Compile）会将源文件（`.c`文件）转换为目标文件。对于 VC/VS，目标文件后缀为`.obj`；对于[GCC](https://c.biancheng.net/gcc/)，目标文件后缀为`.o`。
2. 链接（Link）是针对多个文件的，它会将编译生成的多个目标文件以及系统中的库、组件等合并成一个可执行程序。

预处理为解决的问题，举例：

- 想要在程序中使用sleep函数，并且希望该程序能够同时顺利在windows和linux下都能成功运行。但问题是，windows下暂停函数为`void Sleep(DWORD dwMilliseconds)`（S为大写，参数单位为毫秒，头文件为`<windows.h>`），而linux下暂停函数为`unsigned int sleep(unsigned int seconds)`（参数单位是秒，头文件为`<unistd.h>`）

- 最简单的解决思路就是，我们将两个头文件以及暂停函数按照正常步骤编写进程序中，但是设置运行条件，当识别为windows平台时，将linux平台对应的函数及头文件注释掉，反之亦然。

- 不过，预处理具体做法并不是注释掉一个，而是通过对程序的文本语句处理，根据条件启用不同的程序语句

```c
//不同的平台下引入不同的头文件
#if _WIN32  //识别windows平台
#include <windows.h>
#elif __linux__  //识别linux平台
#include <unistd.h>
#endif
```

- `\#if`、`#elif`、`#endif` 就是预处理命令，它们都是在编译之前由预处理程序来执行的。这里我们不讨论细节，只从整体上来理解。

# 8.2 C语言#include的用法详解（文件包含命令）

- `#include`叫做文件包含命令，用来引入对应的头文件（`.h`文件）。#include 也是C语言预处理命令的一种。

![演示#include的用法](https://c.biancheng.net/uploads/allimg/190114/1-1Z114155F6403.gif)

- `my.c` 所包含的代码：

```c
//计算从m加到n的和
int sum(int m, int n) {
	int i, sum = 0;
	for (i = m; i <= n; i++) {
		sum += i;
	}
	return sum;
}
```

- `my.h` 所包含的代码：

```c
//声明函数
int sum(int m, int n);
```

- `main.c` 所包含的代码：

```c
#include <stdio.h>
#include "my.h"

int main() {
	printf("%d\n", sum(1, 100));
	return 0;
}
```

- 「在头文件中定义定义函数和全局变量」这种认知是原则性的错误！不管是标准头文件，还是自定义头文件，**都只能包含变量和函数的声明**，**不能包含定义**，否则在多次引入时会引起重复定义错误。

# 8.3 C语言#define的用法，C语言宏定义

\#define 叫做宏定义命令，它也是C语言预处理命令的一种。所谓宏定义，就是用一个标识符来表示一个字符串，如果在后面的代码中出现了该标识符，那么就全部替换成指定的字符串。

- 一个简单用法

  ```c
    #include <stdio.h>
    
    #define N 100
    
    int main(){
    	int sum = 20 + N;
    	printf("%d\n", sum);
    	return 0;
    }
    ```

  - 在预处理阶段，对程序中所有出现的“宏名”，预处理器都会用宏定义中的字符串去代换，这称为“宏替换”或“宏展开”。

- **宏定义**：`#define`；**宏替换**：预处理程序完成

- 使用宏定义命令时的一些注意事项：

  - `#define M (n*n+3*n)`这里的括号不能少，否则在宏展开时，该公式参与计算的部分执行顺序会发生问题
  - 宏定义是一种简单粗暴的对程序中指定文本字符串的替换（包括常数、表达式、if语句、函数等等），如果出错则只能在编译已被宏展开后的源程序中发现

  - **宏定义不是说明或语句，不需要加分号**，否则会连分号一同替换

  - 宏定义必须写在函数之外，作用域：宏定义命令`#define PI 3.14`起到源程序结束或者`#undef PI`为止

  - 宏定义不处理被引号包围的宏名，如`#define OK 100`不会替换`printf("OK\n");`中的宏名`OK`

  - 宏名允许嵌套

  - 习惯上用大写字母表示

  - 使用宏定义来表示数据类型时，要注意其与`typedef`定义数据说明符不同。

    - **宏定义只是简单的字符串替换，预处理器处理**
    - **`typedef`是编译阶段编译器处理，是一个新的数据类型**

    - 例如：

     ```c
      #define PIN1 int *
      typedef int *PIN2;
      
      PIN1 a, b; // 相当于 int *a, b; 这会导致a为整型指针而b只是整型
      PIN2 c, d; // 两个都为整型指针
      ```

# 8.4 C语言带参数的宏定义

对带参数的宏，在展开过程中不仅要进行字符串替换，还要用实参去替换形参。

带参宏定义的一般形式为：`#define 宏名(形参列表) 字符串`

例如：

```
#define M(y) y*y+3*y  //宏定义
// TODO:
k=M(5);  //宏调用
```

但需要注意的是：

- 形参之间可以出现空格，但是宏名和形参列表之间不能有空格出现

  ```c
    #define MAX(a,b) (a>b)?a:b
    修改为：
    #define MAX  (a,b)  (a>b)?a:b // 要替换的字符串变为：(a,b)  (a>b)?a:b
    ```

- **带参宏定义中，不会为形式参数分配内存**，因此不必指明数据类型

  - 在带参数的宏中，**只是符号的替换**，不存在值传递的问题

- 在宏定义中，字符串内的形参通常要用括号括起来以避免出错

```c
#include <stdio.h>
#define SQ(y) y*y
int main(){
	int a, sq;
	printf("input a number: ");
	scanf("%d", &a);
	sq = SQ(a+1); // 替换后变为：a+1*a+1
	printf("sq=%d\n", sq);
	return 0;
}
```

```c
// 但只是对参数加括号还不够
#define SQ(y) (y)*(y)
// 如果遇到：
sq = 20 / SQ(a+1); // 替换后变为：20/(a+1) * (a+1)
```

```c
// 所以，不仅要在参数两侧加括号，还需要在整个字符串外加括号
#define SQ(y) ((y)*(y))
```

# 8.5 C语言带参宏定义和函数的区别

- 带参宏定义
  - 宏展开只是字符串上的替换，不会对表达式进行计算
  - 不参与编译，起作用在编译之前
  - 对程序文本进行替换，故不占用内存
- 函数
  - 一段可以重复利用的代码
  - 参与编译
  - 会分配内存，每次调用函数，即为执行对应内存中的代码

# 8.6 C语言宏参数的字符串化和宏参数的连接

在宏定义中，有时还会用到`#`和`##`两个符号，它们能够对宏参数进行操作

## # 的用法

`#`用来将宏参数转换为字符串，也就是在宏参数的开头和末尾添加引号。例如有如下宏定义：

```c
#define STR(s) #s
```

那么：

```c
printf("%s", STR(c.biancheng.net));
printf("%s", STR("c.biancheng.net"));
```

分别被展开为：

```c
printf("%s", "c.biancheng.net");
printf("%s", "\"c.biancheng.net\"");
```

## ##的用法

`##`称为连接符，用来将宏参数或其他的串连接起来。例如有如下的宏定义：

```c
#define CON1(a, b) a##e##b
#define CON2(a, b) a##b##00
```

那么：

```c
printf("%f\n", CON1(8.5, 2));
printf("%d\n", CON2(12, 34));
```

将被展开为：

```c
printf("%f\n", 8.5e2);  // 850.000000
printf("%d\n", 123400); // 123400
```

# 8.7 C语言中几个预定义宏

ANSI C 规定了以下几个预定义宏，它们在各个编译器下都可以使用：

- `__LINE__`：表示当前源代码的行号；
- `__FILE__`：表示当前源文件的名称；
- `__DATE__`：表示当前的编译日期；
- `__TIME__`：表示当前的编译时间；
- `__STDC__`：当要求程序严格遵循ANSI C标准时该标识被赋值为1；
- `__cplusplus`：当编写C++程序时该标识符被定义。

# 8.8 C语言#if、##ifdef、#ifndef的用法详解，C语言条件编译详解

## `#if` 的用法

`\#if` 用法的一般格式为：

```c
#if 整型常量表达式1
  程序段1
#elif 整型常量表达式2
  程序段2
#elif 整型常量表达式3
  程序段3
#else
  程序段4
#endif
```

- 需要注意`#if`后需要的是**整型常量表达式**，而`if`后的表达式并没有这种限制

## `#ifdef` 的用法

`#ifdef`用法的一般格式：

```c
#ifdef  宏名
  程序段1
#else
  程序段2
#endif
```

- 当前宏名是否被定义

- 使用：

```c
#include <stdio.h>
#include <stdlib.h>
int main(){
	#ifdef _DEBUG
		printf("正在使用 Debug 模式编译程序...\n");
	#else
		printf("正在使用 Release 模式编译程序...\n");
	#endif
	system("pause");
	return 0;
}
```

  - 根据目前程序是debug还是release模型来输出不同的提示

  - VS/VC 有两种编译模式，Debug 和 Release。**在学习过程中，我们通常使用 Debug 模式，这样便于程序的调试**；而**最终发布的程序，要使用 Release 模式，这样编译器会进行很多优化，提高程序运行效率，删除冗余信息**

# `#ifndef`的用法

`#ifndef`用法的一般格式为：

```c
#ifndef 宏名
  程序段1 
#else 
  程序段2 
#endif
```

# 8.9 C语言#error命令，阻止程序编译

\#error 指令用于在编译期间产生错误信息，并阻止程序的编译，其形式如下：

```c
#error error_message
```

例如，我们的程序针对 Linux 编写，不保证兼容 Windows，那么可以这样做：

```c
#ifdef WIN32
#error This programme cannot compile at Windows Platform
#endif
```

- 这里的`This programme cannot compile at Windows Platform`不需要加上引号
- 加上引号后会一同输出

当我们希望以 C++ 的方式来编译程序时，可以这样做：

```c
#ifndef __cplusplus
#error 当前程序必须以C++方式编译
#endif
```

# 8.10 C语言预处理命令总结

- 预处理指令是以`#`号开头的代码行，# 号必须是该行除了任何空白字符外的第一个字符。# 后是指令关键字，在关键字和 # 号之间允许存在任意个数的空白字符，整行语句构成了一条预处理指令，该指令将**在编译器进行编译之前对源代码做某些转换**。
- 预处理功能是C语言特有的功能，它是在对源程序正式编译前由**预处理程序**完成的，程序员在程序中用预处理命令来调用这些功能。
- 宏定义可以带有参数，宏调用时是以实参**代换**形参，而**不是“值传送”**。
- 为了避免宏代换时发生错误，**宏定义中的字符串应加括号**，字符串中出现的**形式参数两边也应加括号**。
- **文件包含**是预处理的一个重要功能，它可用来**把多个源文件连接成一个源文件进行编译**，结果将**生成一个目标文件**。
- **条件编译**允许只编译源程序中满足条件的程序段
  - 使生成的**目标程序较短**，从而**减少了内存的开销**并提高了程序的效率。
- 使用**预处理功能**便于程序的**修改、阅读、移植和调试**，也便于实现**模块化程序设计**。